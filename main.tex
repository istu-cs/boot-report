\documentclass[11pt]{article}
\usepackage{xltxtra}
\usepackage{polyglossia}
\setdefaultlanguage[spelling=modern]{russian}
%\setmainfont[Mapping=tex-text]{DejaVu Sans}
%\setmainfont[Mapping=tex-text]{Liberation Sans}
\setmonofont[Mapping=tex-text]{DejaVu Sans Mono}
\setmainfont[Mapping=tex-text]{Linux Libertine O}
%\setmonofont[Mapping=tex-text]{Liberation Mono}

\usepackage{verbatim}
\usepackage{tabularx}
\usepackage{float}
\usepackage{url}

\usepackage{indentfirst}

\usepackage{algorithm}
\usepackage{algorithmic}

\usepackage[a4paper]{geometry}
\geometry{left=25mm}
\geometry{right=25mm}
\geometry{top=25mm}
\geometry{bottom=15mm}

\usepackage{listings}

\setlength{\parindent}{10mm}
\makeatletter
% Переопределение команды секции
\renewcommand{\section}{\@startsection{section}{1}%
{\parindent}{3.25ex plus 1ex minus .2ex}%
{1.5ex plus .2ex}{\bfseries\large\uppercase}}

% Переопределение команды подсекции
\renewcommand{\subsection}{\@startsection{subsection}{2}%
{\parindent}{3.25ex plus 1ex minus .2ex}%
{1.5ex plus .2ex}{\bfseries}}
\makeatother

\newcommand{\includepicture}[3]{
\begin{figure}[H]
\begin{center}
\leavevmode
%\large{\textbf{#2}}
\includegraphics[width=#3\textwidth]{#1}
\end{center}
\caption{#2}
\end{figure}
}

\lstset{ %
language=C++,                   % the language of the code
basicstyle=\tiny,               % the size of the fonts that are used for the code
numbers=left,                   % where to put the line-numbers
numberstyle=\footnotesize,      % the size of the fonts that are used for the line-numbers
stepnumber=2,                   % the step between two line-numbers. If it's 1, each line
                                % will be numbered
numbersep=5pt,                  % how far the line-numbers are from the code
%backgroundcolor=\color{white},  % choose the background color. You must add \usepackage{color}
showspaces=false,               % show spaces adding particular underscores
showstringspaces=false,         % underline spaces within strings
showtabs=false,                 % show tabs within strings adding particular underscores
frame=single,                   % adds a frame around the code
tabsize=2,                      % sets default tabsize to 2 spaces
captionpos=b,                   % sets the caption-position to bottom
breaklines=true,                % sets automatic line breaking
breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
title=\lstname,                 % show the filename of files included with \lstinputlisting;
                                % also try caption instead of title
escapeinside={\%*}{*)},         % if you want to add a comment within your code
morekeywords={*,...}            % if you want to add more keywords to the set
}

\begin{document}

\tableofcontents
\pagebreak

\section{Постановка задачи}

При поддержке большого парка машин существует необходимость
автоматизации настройки каждой из машин в отдельности,
т.е. задача администратора в идеальном случае должна
сводиться к однократной настройке системы (вместо
повторения одних и тех же действий многократно на каждой машине).

Кроме того, порой возникает необходимость временного изменения
процесса загрузки определённой группы машин. Например, на время
проведения соревнований, для сбора какой-либо информации о машинах...

Одним из способов решения данной задачи является использование сетевой загрузки.

\section{Методы решения задачи}

\subsection{Введение}
Сетевая загрузка -- разновидность инициализации системы, при которой часть системного
кода загружается с удалённой машины (сервера). Загружаться удалённо может как загрузчик,
так и операционная система. Существует множество способов настройки, при которых
может использоваться как только BIOS или EFI, так и загрузчик с жёсткого диска.

Многое зависит от конкретного оборудования и программного обеспечения.
Часть устаревших BIOS'ов не поддерживают
технологию PXE (Preboot eXecution Environment),
в этом случае требуется установка специального загрузчика на жёсткий диск.
Операционные системы семейства Windows также достаточно сложно настроить для загрузки по сети,
поэтому их проще установить на жёсткий диск (при этом загрузчик может быть удалённым).

\subsection{Идентификация и группировка машин}
Машины могут быть идентифицированы при помощи MAC-адреса.
% TODO Стоит ли указать, что это частный случай и можно использовать любой ключ?
Имея таблицу соответствия MAC-адреса и описания самой машины
(например, аудитория + номер) администратор без труда
объединять нужные машины в группы. В пределах одной группы
машины загружаются одинаково. Таким образом, группе соответствует
конфигурация загрузки.

\includepicture{groups}{Группы машин}{1}

\section{Реализация}

\subsection{Загрузчики}
Для осуществления загрузки по сети используются загрузчики pxelinux (проект syslinux)
и gPXE (проект etherboot). pxelinux поддерживает гибкую настройку экрана приветствия,
а также позволяет загружать различные операционные системы (в том числе Windows и GNU/Linux).
gPXE поддерживает загрузку по протоколу HTTP (в то время, как pxelinux только по протоколу TFTP),
что позволяет передать серверу всю необходимую информацию в адресе.

\subsection{Процесс загрузки}
В общем случае все машины можно разделить на два класса:
\begin{itemize}
    \item Поддерживают PXE: для загрузки используется BIOS/EFI/etc.

        В этом случае сценарий загрузки следующий:
        \begin{enumerate}
            \item BIOS получает адрес от DHCP-сервера,
                а также путь до pxelinux, доступного на TFTP-сервере.
            \item BIOS загружает с TFTP-сервера pxelinux.0 (файл загрузчика)
                и передаёт ему управление
            \item pxelinux.0 загружает конфигурационный файл с TFTP сервера,
                в котором указано, что необходимо загрузить gPXE (тоже с TFTP-сервера)
            \item pxelinux.0 загружает gPXE с TFTP-сервера и передаёт ему управление
            \item gPXE заново инициализирует сетевой стек
        \end{enumerate}


    \item Не поддерживают PXE: для таких машин требуется установка загрузчика
        с поддержкой PXE на жёсткий диск.

        В этом случае сценарий загрузки следующий:
        \begin{enumerate}
            \item BIOS загружает extlinux с жёсткого диска и передаёт ему управление
            \item extlinux загружает gPXE c жёсткого диска и передаёт ему управление
            \item gPXE инициализирует сетевой стек
        \end{enumerate}
\end{itemize}

Дальнейший сценарий в обоих случаях одинаковый:
\begin{enumerate}
    \item gPXE делает запрос DHCP-серверу
    \item DHCP-сервер возвращает путь до скрипта gPXE на HTTP-сервере
    \item gPXE загружает скрипт, в котором указано загрузить pxelinux.0
        с HTTP-сервера с указанием MAC-адреса в URL:
        \url{http://boot.cs.istu.ru:81/MAC-адрес/pxelinux.0}
    \item gPXE загружает pxelinux.0 и передаёт ему управление
    \item pxelinux загружает конфигурационный файл (путь до файла
        вычисляется относительно пути до pxelinux.0,
        соответственно, MAC-адрес остаётся в пути)
    \item pxelinux загружает конфигурационный файл,
        специфичный для группы машин, к которой относится машина
        с представленным MAC-адресом
    \item далее происходит передача управления программе отрисовки
        меню либо загрузчику операционной системы
\end{enumerate}

\subsection{Сервер}
Серверная часть проекта работает под управлением операционной
системы GNU/Linux.

\subsubsection{DHCPD}
В качестве DHCP-сервера используется ISC DHCP.
Он настроен таким образом, что при запросе поля
filename, используемого PXE-клиентами как имя
загрузчика или скрипта для загрузчика,
он возвращает путь до скрипта gPXE на HTTP-сервере,
если клиент передал user-class равный "gPXE",
иначе "pxelinux.0", доступный на TFTP сервере.

\subsubsection{TFTPD}
TFTP-сервер хранит pxelinux.0 с конфигурационным
файлом, смысл которого загрузить gPXE, находящийся
на том же сервере.

\subsubsection{boot -- менеджер конфигурационных файлов загрузчика}

\paragraph{boot-сервер} представляет из себя WEB-сервис, задача которого состоит в
\begin{itemize}
    \item предоставлении доступа к конфигурации для удалённых загрузчиков по протоколу HTTP
    \item предоставлении администраторам удобного инструмента для редактирования профилей загрузки
\end{itemize}

Как было сказано выше, существует необходимость разделения машин на группы,
где каждой группе соответствует определённая конфигурация загрузки. Принадлежность
определённой машины к группе задаёт администратор. Сама же машина идентифицируется ключом,
который передаётся как часть URL. Ключом является MAC-адрес сетевой карты, с которой
происходит загрузка.

\paragraph{Реализован} boot-сервер на языке программирования Python
с использованием фреймворка для WEB-приложений Django.

\subsubsection{NFSD}
Для загрузки GNU/Linux клиентов необходим образ
корневой файловой системы. Он доступен клиентам
по протоколу NFS в асинхронном режиме, так как
запись на сервер не производится.

Помимо этого, иногда возникает необходимость
сохранять на сервере информацию, например, образы
разделов с Windows. В этом случае используется
синхронный режим для лучшей стабильности.

\subsection{Клиент}

\subsubsection{GNU/Linux}
Операционную систему GNU/Linux можно загрузить по-сети
штатными средствами. Существует довольно много различных
конфигураций, но в нашем случае есть ряд требований:
\begin{itemize}
    \item Клиент не должен иметь возможности изменить образ на сервере.
    \item Клиент должен иметь возможность изменять данные локально.
\end{itemize}

Изложенным выше требованиям соответствует конфигурация, при которой
корень файловой системы находится на сервере и доступен по NFS
в режиме только чтение (read-only). Для реализации второго требования
можно воспользоваться файловой системой aufs3, которая позволяет
наложить на недоступный для записи слой другой слой,
уже доступный для записи. Таким образом мы получим файловую систему
с возможностью изменения файлов. Но благодаря технологии Copy-On-Write (cow),
в верхний перезаписываемый уровень файловой системы копируются только те файлы,
которые клиент пытается изменить. Остальные же файлы доступны из нижнего
неперезаписываемого уровня файловой системы. Таким образом достигается
достаточно высокая эффективность работы с такой файловой системы в сравнении
с полным копированием корневой файловой системы или отдельных директорий,
которые должны быть доступны для перезаписи.

Благодаря лёгкости настройки данной операционной системы, с её помощью реализуется
ещё одна задача: выполнение заданий на клиентской машине. Например,
создание и разворачивание образов Windows, сбор информации об аппаратном
обеспечении, запуск сервера проверки решений системы BACS. Это легко сделать
передавая определённые опции ядру, которое загружает нужный init-script
и выполняет необходимую инициализацию системы.

\subsubsection{Windows}
Операционные системы семейства Windows проще установить на жёсткий
диск по двум причинам:
\begin{enumerate}
    \item Сложность настройки загрузки по-сети (проприетарное ПО).
    \item Необходимость установки различных имён машин в Active Directory,
        но при загрузке по сети образ идентичен. Конечно, существует
        теоретическая возможность вмешаться в процесс загрузки и изменить
        часть настроек ОС, как это происходит с GNU/Linux, но это представляет
        собой проблему для проприетарного ПО.
\end{enumerate}

\section{Тестовые примеры}
% TODO скриншоты из qemu

\section{Выводы}
В ходе данной работы была создана многокомпонентная система,
позволяющая значительно облегчить процесс администрирования больших групп машин.

Гибкость построенной системы дает возможность применять её для создания различных
профилей загрузки операционных систем семейства Windows и GNU/Linux.

Открытость всех компонентов и программных платформ системы
значительно облегчает модификацию и добавление новых функций.

Недостатками данной системы являются:
\begin{itemize}
    \item сложность развёртывания в сети: требуется интеграция с DHCP-сервером, а также настройка TFTP и HTTP серверов.
    \item возможность применения только в пределах локальной сети.
\end{itemize}

\end{document}
